// src/index.ts
import { build } from "esbuild";
import { builtinModules } from "node:module";
import fs from "node:fs";
import cpr from "cpr";
import { promisify } from "node:util";
async function bundle(options = {}) {
  const {
    outputDir = ".vercel/output",
    clearOutputDir = true,
    staticDir,
    edgeEntry,
    serverlessEntry,
    manipulateEsbuildOptions
  } = options;
  if (!staticDir && !edgeEntry && !serverlessEntry) {
    throw new Error(
      "Must provide at least one of staticDir, edgeEntry, or serverlessEntry"
    );
  }
  if (clearOutputDir && fs.existsSync(outputDir)) {
    await fs.promises.rm(outputDir, { recursive: true, force: true });
  }
  await fs.promises.mkdir(outputDir, { recursive: true });
  if (staticDir) {
    await promisify(cpr)(staticDir, outputDir + "/static", {
      deleteFirst: true
    });
  }
  if (edgeEntry) {
    await bundleEdgeFunction(
      edgeEntry,
      outputDir + "/functions/_edge.func",
      manipulateEsbuildOptions
    );
    await fs.promises.writeFile(
      outputDir + "/functions/_edge.func/.vc-config.json",
      JSON.stringify(
        {
          runtime: "edge",
          entrypoint: "index.js"
          // TODO: Investigate and expose envVarsInUse
        },
        null,
        2
      )
    );
  }
  if (serverlessEntry) {
    await bundleServerlessFunction(
      serverlessEntry,
      outputDir + "/functions/_serverless.func",
      manipulateEsbuildOptions
    );
    await fs.promises.writeFile(
      outputDir + "/functions/_serverless.func/.vc-config.json",
      JSON.stringify(
        {
          runtime: "nodejs18.x",
          handler: "index.js",
          launcherType: "Nodejs",
          supportsResponseStreaming: options.streaming ?? true
        },
        null,
        2
      )
    );
  }
  await createConfigFile(outputDir, {
    static: !!staticDir,
    edge: !!edgeEntry,
    serverless: !!serverlessEntry
  });
}
async function bundleEdgeFunction(entry, outputDir, manipulateEsbuildOptions) {
  const esbuildOptions = {
    logLevel: "info",
    bundle: true,
    minify: true,
    entryPoints: [entry],
    outfile: outputDir + "/index.js",
    platform: "browser",
    target: "chrome96",
    format: "cjs",
    // Top-level await is not supported in ESM
    mainFields: ["module", "main", "browser"],
    conditions: ["edge-light", "worker", "import", "require"],
    external: builtinModules
  };
  await manipulateEsbuildOptions?.(esbuildOptions, "serverless");
  await build(esbuildOptions);
}
async function bundleServerlessFunction(entry, outputDir, manipulateEsbuildOptions) {
  const esbuildOptions = {
    logLevel: "info",
    bundle: true,
    minify: true,
    entryPoints: [entry],
    outfile: outputDir + "/index.js",
    platform: "node",
    target: "node18",
    format: "cjs",
    external: builtinModules
  };
  await manipulateEsbuildOptions?.(esbuildOptions, "serverless");
  await build(esbuildOptions);
}
async function createConfigFile(outputDir, options) {
  const config = {
    version: 3,
    routes: [
      options.static && {
        handle: "filesystem"
      },
      options.edge && options.serverless && {
        src: ".*",
        middlewarePath: "_edge",
        continue: true
      },
      options.edge && !options.serverless && {
        src: ".*",
        dest: "_edge"
      },
      options.serverless && {
        src: ".*",
        dest: "_serverless"
      }
    ].filter(Boolean)
  };
  await fs.promises.writeFile(
    outputDir + "/config.json",
    JSON.stringify(config, null, 2)
  );
}

export {
  bundle,
  bundleEdgeFunction,
  bundleServerlessFunction
};
